<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Social Stream - Overlay</title>
    <meta name="title" content="Social Stream - Overlay" />
    <link rel="icon" href="./favicon.ico" />
    <link rel="preload" href="./thirdparty/NotoColorEmoji.ttf" as="font" type="font/ttf" crossorigin />
    <meta name="robots" content="noindex">
    <style>
		/* -- TEMA KUSTOM FINAL UNTUK TEMPLAT HIGHLIGHT (VERSI LENGKAP DENGAN ORNAMEN) -- */

        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;900&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
        }

        .output {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 400px;
        }

        .highlight-chat {
            padding: 0 !important; background: none !important; border: none !important;
            border-radius: 0 !important; backdrop-filter: none !important; box-shadow: none !important;
            opacity: 0;
            animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            display: inline-block;
            align-self: flex-start;
        }

        .hl-name {
            font-weight: 700; color: #ffffff; padding: 2px 10px;
            border-radius: 12px; font-size: 10px !important; position: absolute;
            top: -10px; left: 20px; z-index: 99; background-color: #222222;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 180px;
        }

        .hl-message {
            font-weight: 700; background: #222222; color: #ffffff;
            font-size: 14px !important; padding: 16px 24px;
            border-radius: 4px 24px 4px 24px; display: inline-block;
            min-width: 100px; box-sizing: border-box; overflow-wrap: break-word;
            position: relative; left: 10px; margin-left: 0 !important;
        }

        .hl-message img.emoji {
            width: 14px; height: 14px; vertical-align: middle;
        }

        /* Ornamen dasar */
        .hl-message::before, .hl-message::after, .ornament-extra-1, .ornament-extra-2 {
            content: ''; position: absolute; background-size: contain;
            background-repeat: no-repeat; transform-origin: bottom center;
        }

        /* Owner */
        .highlight-chat.owner .hl-name {
            background-image: linear-gradient(to right, #06EC47, #11B23F);
            color: #222222;
        }
        .highlight-chat.owner .hl-message {
            background-image: linear-gradient(to right, #05531C, #222222);
        }
        .highlight-chat.owner .hl-message::before {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/3flow%20green%20shad.svg');
            width: 48px; height: 32px; top: -11px; right: -11px; z-index: 4;
        }
        .highlight-chat.owner .hl-message::after {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
            width: 28px; height: 20px; bottom: -2px; right: -10px; z-index: 4;
            animation: sway 1s ease-in-out infinite alternate;
        }
        .highlight-chat.owner .ornament-extra-1 {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
            width: 28px; height: 20px; top: 0; left: -14px; z-index: 4;
            transform: rotate(-90deg);
            animation: sway-tilt-neg-90 1s ease-in-out infinite alternate;
        }
        .highlight-chat.owner .ornament-extra-2 {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/1flow%20green%20shad.svg');
            width: 26px; height: 26px; bottom: 12px; left: -13px; z-index: 5;
        }

        /* Moderator */
        .highlight-chat.moderator .hl-name {
            background-image: linear-gradient(to right, #06EC47, #11B23F);
            color: #222222;
        }
        .highlight-chat.moderator .hl-message {
            background-color: #222222;
        }
        .highlight-chat.moderator .hl-message::before {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/1flow%20green%20shad.svg');
            width: 26px; height: 26px; bottom: 12px; left: -13px; z-index: 5;
        }
        .highlight-chat.moderator .hl-message::after {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
            width: 28px; height: 20px; bottom: -2px; right: -10px; z-index: 4;
            animation: sway 1s ease-in-out infinite alternate;
        }

        /* Member & Gifter */
        .highlight-chat.member .hl-name, .highlight-chat.gifter .hl-name {
            background-color: #222222;
            color: #ffffff;
        }
        .highlight-chat.member .hl-message, .highlight-chat.gifter .hl-message {
            background-image: linear-gradient(to right, #00DE3F, #009129);
            color: #222222;
        }
        .highlight-chat.member .hl-message::before, .highlight-chat.gifter .hl-message::before {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/3flow%20blak%20shad.svg');
            width: 48px; height: 32px; top: -11px; right: -11px; z-index: 4;
        }
        .highlight-chat.member .hl-message::after, .highlight-chat.gifter .hl-message::after {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
            width: 28px; height: 20px; bottom: 2px; right: -12px; z-index: 4;
            transform: rotate(90deg);
            animation: sway-tilt-neg90 1s ease-in-out infinite alternate;
        }
        .highlight-chat.member .ornament-extra-1, .highlight-chat.gifter .ornament-extra-1 {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
            width: 28px; height: 20px; top: 0; left: -14px; z-index: 4;
            transform: rotate(-90deg);
            animation: sway-tilt-neg-90 1s ease-in-out infinite alternate;
        }
        .highlight-chat.member .ornament-extra-2, .highlight-chat.gifter .ornament-extra-2 {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/1flow%20black%20shad.svg');
            width: 24px; height: 24px; bottom: 11px; left: -12px; z-index: 5;
        }

        /* Regular */
        .highlight-chat.regular .hl-name {
            background-image: linear-gradient(to right, #06EC47, #11B23F);
            color: #222222;
        }
        .highlight-chat.regular .hl-message {
            background-color: #222222;
            color: #ffffff;
        }
        .highlight-chat.regular .hl-message::before {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/3flow%20green%20shad.svg');
            width: 48px; height: 32px; top: -11px; right: -11px; z-index: 4;
        }


        /* Menyembunyikan elemen asli yang tidak digunakan */
        .hl-img, .hl-badges, .icon.sourcetype, .hl-donation, .hl-title {
            display: none !important;
        }

        /* Animasi */
        @keyframes bounceIn { /* ... */ }
        @keyframes fadeOut { /* ... */ }
        @keyframes sway { /* ... */ }
        @keyframes sway-tilt-neg-90 { /* ... */ }
        @keyframes sway-tilt-neg90 { /* ... */ }
        /* (Sengaja dikosongkan agar tidak terlalu panjang, Anda bisa salin dari kode asli Anda) */
    </style>
</head>
<body>
    <div id="output" class="output"></div>
    <script>
	const urlParams = new URLSearchParams(window.location.search);
	
    const App = {
        config: {
            serverURL: (urlParams.has("localserver") ? "ws://127.0.0.1:3000" : 'wss://io.socialstream.ninja'),
            maxReconnectAttempts: 10,
            reconnectDelay: 100,
            roomIdMaxLength: 80
        },

        state: {
            socketserver: null,
            reconnectionTimeout: null,
            conCon: 1,
            roomID: 'test',
            password: 'false',
            fallbackImage: null,
            fallbackImageAnnouncement: null
        },

        init() {
            this.setupUrlParams();
            this.setupFallbackImages();
            this.initializeConnection();
        },

        initializeConnection() {
            if (urlParams.has('server')) {
                this.config.serverURL = urlParams.get('server') || this.config.serverURL;
                this.setupSocket();
            } else if (urlParams.has('server2')) {
                this.config.serverURL = urlParams.get('server2') || this.config.serverURL;
                this.setupSocket(1);
            } else if (urlParams.has('server3')) {
                this.config.serverURL = urlParams.get('server3') || this.config.serverURL;
                this.setupSocket(2);
            } else {
                this.setupRecvDataWindow();
            }
        },

        setupUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            this.handleRoomIdParam(urlParams);
            this.handlePasswordParam(urlParams);
            this.handleServerParam(urlParams);

            if (urlParams.has('savetodisk')) {
                document.body.onclick = () => this.overwriteFile('setup');
            }
        },

        handlePasswordParam(urlParams) {
            this.state.password = urlParams.get('password') || 'false';
        },

        handleServerParam(urlParams) {
            if (urlParams.has('server')) {
                this.config.serverURL = urlParams.get('server') || this.config.serverURL;
            } else if (urlParams.has('server2')) {
                this.config.serverURL = urlParams.get('server2') || this.config.serverURL;
            } else if (urlParams.has('server3')) {
                this.config.serverURL = urlParams.get('server3') || this.config.serverURL;
            }
        },

        setupRecvDataWindow() {
            const iframe = document.createElement('iframe');
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${this.state.password}&notmobile&salt=vdo.ninja&label=overlay&exclude=${this.state.roomID}&scene&novideo&noaudio&cleanoutput&room=${this.state.roomID}`;
            iframe.id = 'frame1';
            iframe.allow = 'midi;geolocation;microphone;';
            document.body.appendChild(iframe);

            window.addEventListener('message', (e) => {
                if (e.source !== iframe.contentWindow) return;
                
				if (e.data?.dataReceived && ("overlayNinja" in e.data.dataReceived)){
					if ( e.data.dataReceived.overlayNinja){
						this.processData({ contents: e.data.dataReceived.overlayNinja });
					} else {
						 this.processData(false);
					}
				}
            });
        },

        handleRoomIdParam(urlParams) {
            let roomID = urlParams.get('session') || 
                        urlParams.get('s') || 
                        urlParams.get('id');

            if (!roomID && window.location.protocol === 'file:') {
                roomID = prompt('Enter your session ID here, or add it to the URL.');
            } else if (!roomID) {
                window.location.href = 'https://socialstream.ninja/landing';
                return;
            }

            const validatedID = this.validateRoomId(roomID);
            if (!validatedID) {
                this.handleInvalidRoom();
                return;
            }

            this.state.roomID = validatedID;
        },

        setupFallbackImages() {
            this.state.fallbackImage = new Image();
            this.state.fallbackImage.src = './sources/images/unknown.png';
            this.state.fallbackImage.onerror = () => this.state.fallbackImage = null;

            this.state.fallbackImageAnnouncement = new Image();
            this.state.fallbackImageAnnouncement.src = './icons/announcement.png';
            this.state.fallbackImageAnnouncement.onerror = () => this.state.fallbackImageAnnouncement = null;
        },

        validateRoomId(roomId) {
            if (!roomId?.trim()) return false;

            let sanitizedId = String(roomId).trim();
            if (sanitizedId.length < 2) return false;

            const reservedValues = [
                'undefined', 'null', 'false', 'true', 'NaN',
                'default', 'room', 'lobby', 'test', 'nothing',
                '0', '1', 'none'
            ];

            if (reservedValues.includes(sanitizedId.toLowerCase())) return false;

            sanitizedId = sanitizedId.replace(/[^a-zA-Z0-9]/g, '_');
            if (/^_+$/.test(sanitizedId)) return false;
            
            return sanitizedId.length <= this.config.roomIdMaxLength ? sanitizedId : false;
        },

        handleInvalidRoom() {
            document.write('Invalid session ID');
            throw new Error('Invalid session ID');
        },

        setupSocket(allin = false) {
            if (this.state.reconnectionTimeout) {
                clearTimeout(this.state.reconnectionTimeout);
                this.state.reconnectionTimeout = null;
            }

            if (this.state.socketserver) {
                this.state.socketserver.onclose = null;
                this.state.socketserver.close();
            }

            this.state.socketserver = new WebSocket(this.config.serverURL);
            this.initializeSocketHandlers(allin);
        },

        initializeSocketHandlers(allin) {
            const socket = this.state.socketserver;

            socket.onclose = () => {
                if (this.state.conCon <= this.config.maxReconnectAttempts) {
                    this.state.reconnectionTimeout = setTimeout(() => {
                        this.state.conCon++;
                        this.setupSocket(allin);
                    }, this.config.reconnectDelay * this.state.conCon);
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                socket.close();
            };

            socket.onopen = () => {
                this.state.conCon = 1;
                const message = {
                    join: this.state.roomID,
                    out: 3
                };

                if (allin === 2) {
                    message.in = 2;
                } else if (allin === 1) {
                    message.in = 1;
                }

                socket.send(JSON.stringify(message));
            };

            socket.onmessage = this.handleSocketMessage.bind(this);
        },

        handleSocketMessage(event) {
            if (!event.data) return;

            let data;
            try {
                data = typeof event.data === 'object' ? event.data : JSON.parse(event.data);
            } catch (error) {
                console.error('Error parsing message:', error);
                return;
            }

            const pid = data?.get || false;
            if (data?.overlayNinja) {
                data = data.overlayNinja;
            }

            const resp = this.processData(data);
            if (resp !== null) {
                const ret = {
                    callback: {
                        ...data,
                        result: resp,
                        get: pid
                    }
                };
                this.state.socketserver.send(JSON.stringify(ret));
            }
        },

        processData(data) {
            if (!data || data === false || (data.contents && data.contents === false) || (data.content === false)) {
                document.getElementById('output').innerHTML = '';
                return true;
            }

            if (data.contents) {
                const content = data.contents;
                if (!content.chatmessage && !content.chatname && 
                    !content.contentimg && !content.donation && 
                    !content.hasDonation && !content.memebership && 
                    !content.hasMembership) {
                    return;
                }
                
                this.showMessage(content);
                return true;
            }

            return null;
        },

        errorImage(ele) {
            if (ele.dataset.backupImage) {
                ele.src = ele.dataset.backupImage;
            } else if (this.state.fallbackImage) {
                ele.src = './sources/images/unknown.png';
            } else {
                ele.style.display = 'none';
            }
        },

        showMessage(data) {
            // Ambil konten utama dari data
            const content = data;

            // 1. Logika Deteksi Peran (diambil dari addMessageToOverlay Anda)
            // =============================================================
            let roleClass = 'regular';
            if (content.chatbadges) {
                const badgeSrcs = content.chatbadges.map(badge => (badge.src || badge).toLowerCase());
                
                if (badgeSrcs.some(src => src.includes('broadcaster') || src.includes('owner'))) {
                    roleClass = 'owner';
                } else if (badgeSrcs.some(src => src.includes('moderator') || src.includes('moderater'))) {
                    roleClass = 'moderator';
                } else if (
                    badgeSrcs.some(src =>
                        src.includes('gifter') ||
                        src.includes('subscriber') ||
                        src.includes('member') ||
                        (src.includes('fans_badge') && !src.includes('grey'))
                    )
                ) {
                    roleClass = 'member';
                }
            }

            // 2. Pembuatan HTML Sesuai Peran & Tipe Event
            // ===========================================
            let messageContent = '';

            // Jika ini adalah donasi atau subscriber baru, gunakan format "Special Card"
            if (content.hasDonation || content.membership) {
                let badgeText = 'EVENT';
                let messageText = content.hasDonation || content.membership;
                let cardRole = 'regular';

                if (content.hasDonation) {
                    badgeText = 'DONATION';
                    cardRole = 'donation';
                } else if (content.membership) {
                    badgeText = 'NEW SUBSCRIBER';
                    cardRole = 'new-subscriber';
                }
                
                messageContent = `
                    <div class="chat-message ${cardRole}">
                        <div class="special-card ${cardRole}">
                            <div class="special-badge">${badgeText}</div>
                            <div class="special-message">${content.chatname} ${messageText}</div>
                        </div>
                    </div>
                `;
            } 
            // Jika tidak, gunakan format pesan biasa
            else {
                messageContent = `
                    <div class="chat-message ${roleClass}">
                        <div class="badge">${content.chatname}</div>
                        <div class="message">
                            ${content.chatmessage}
                            <span class="ornament-extra-1"></span>
                            <span class="ornament-extra-2"></span>
                        </div>
                    </div>
                `;
            }

            // 3. Tampilkan Hasilnya ke Layar
            // ================================
            document.getElementById('output').innerHTML = messageContent;
        },

        buildMessageContent(data) {
            const imgContent = this.buildImageContent(data);
            const avatarImg = this.buildAvatarImage(data);
            const chatbadges = this.buildChatBadges(data.chatbadges);
            const sourceType = this.buildSourceType(data.type);
            const styleOverride = this.getStyleOverride(data);
			const donationContent = this.buildDonation(data);

            return `
                <div class="hl-c-cont highlight-chat" id="newmessage" data-source-type="${data.type || 'none'}">
					<div class="hl-title">
					${avatarImg}
                    <div class="hl-name" ${styleOverride} id="nameDIV">
                        ${data.chatname || ''}
                    </div>
					${chatbadges}${donationContent}
					</div>
                    <div id="message" class="hl-message">${data.chatmessage || ''}</div>
                   ${sourceType}${imgContent}
                </div>
            `;
        },

        buildImageContent(data) {
            if (!data.contentimg) return '';

            const isVideo = data.contentimg.includes('.mp4') || data.contentimg.includes('.webm');
            const mediaElement = isVideo ? 
                `<video loop="true" autoplay="true" muted="true" src="${data.contentimg}" onerror="this.parentElement.style.display='none'" />` :
                `<img src="${data.contentimg}" onerror="this.parentElement.style.display='none'" />`;

            return `<div class="hl-imgContent">${mediaElement}</div>`;
        },

        buildAvatarImage(data) {
            const imgSrc = data.chatimg || (!data.chatname && data.event ? 
                './icons/announcement.png' : './sources/images/unknown.png');

            const backupAttr = data.backupChatimg ? 
                `data-backup-image="${data.backupChatimg}"` : '';

            return `
                <div class="hl-img">
                    <img id="img_${data.id}" 
                         src="${imgSrc}" 
                         class="hl-profile-pic" 
                         ${backupAttr}
                         onerror="App.errorImage(this)" />
                </div>`;
        },

        buildChatBadges(badges) {
            if (!badges?.length) return '';

            const badgeElements = badges.map(badge => {
                if (typeof badge === 'object') {
                    if (badge.type === 'img' && badge.src) {
                        return `<img class="hl-badge" src="${badge.src}" />`;
                    } else if (badge.type === 'svg' && badge.html) {
                        return `<span class="hl-badge">${badge.html}</span>`;
                    }
                } else {
                    return `<img class="hl-badge" src="${badge}" />`;
                }
                return '';
            }).join('');

            return badgeElements ? `<div class="hl-badges">${badgeElements}</div>` : '';
        },
		
		buildDonation(data) {
            if (!(data.hasDonation || data.donation)) return '';

            const donationAmount = (data.hasDonation || data.donation);
            return `<div class="hl-donation">${donationAmount}</div>`;
        },

        buildSourceType(type = 'none') {
            return `
                <img src="./sources/images/${type}.png" 
                     class="icon sourcetype" 
                     data-icon-name="${type}" 
                     onerror="this.style.display='none'" />`;
        },

        getStyleOverride(data) {
            const styles = [];
            
            if (data.backgroundColor) {
                styles.push(data.backgroundColor.startsWith('background-color:') ? 
                    data.backgroundColor : `background-color: ${data.backgroundColor}`);
            }
            
            if (data.nameColor) {
                styles.push(`color: ${data.nameColor}`);
            } else if (data.textNameColor) {
                styles.push(data.textNameColor);
            }
            
            return styles.length ? `style="${styles.join('; ')}"` : '';
        },

        handleTwitchImage(data) {
            const username = data.username || data.chatname;
            if (data.type !== 'twitch' || !username) return;

            if (!data.chatimg || data.chatimg.startsWith('https://api.socialstream.ninja')) {
                const twitchImage = new Image();
                const imageUrl = `https://api.socialstream.ninja/twitch/large?username=${encodeURIComponent(username)}`;
                
                twitchImage.onload = () => {
                    const imgElement = document.getElementById(`img_${data.id}`);
                    if (imgElement) {
                        imgElement.src = imageUrl;
                    }
                };
                
                twitchImage.src = imageUrl;
            }
        },

        overwriteFile(type) {
            console.log('Save to disk functionality:', type);
        }
    };

    // Initialize the application when DOM is ready
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
