<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Social Stream - Custom Highlight</title>
    <meta name="robots" content="noindex">
    <style>
        /* -- TEMA KUSTOM FINAL ANDA -- */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;900&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
        }

        #output {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            max-width: min(90vw, 500px);
            width: 100%;
            display: flex;
            overflow: visible;
        }

        /* Ini adalah nama class yang dibuat oleh JS di bawah */
        .chat-message {
            opacity: 0;
            animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            display: block;
            width: 100%;
        }

        .badge {
            font-weight: 900; color: #ffffff; padding: 10px 32px;
            border-radius: 40px; font-size: 20px; position: absolute;
            z-index: 99; background-color: #222222;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;
            top: -24px; left: 50%; transform: translateX(-50%);
            max-width: 100%;
        }

        .message {
            font-weight: 700; background: #222222; color: #ffffff;
            font-size: 30px; padding: 30px 38px; text-align: center;
            border-radius: 4px 24px 4px 24px;
            box-sizing: border-box; overflow-wrap: break-word;
            position: relative; display: block;
            width: 100%;
        }

        .message img {
            /* Atur ukuran yang diinginkan */
            width: 28px !important;
            height: 28px !important;

            /* Jaga agar tetap sejajar dengan teks */
            vertical-align: middle !important;
            
            /* Perbaikan visual minor */
            display: inline-block !important;
            margin: -4px 2px 0 2px !important;
        }

        .message::before, .message::after, .ornament-extra-1, .ornament-extra-2 {
            content: ''; position: absolute; background-size: contain;
            background-repeat: no-repeat; transform-origin: bottom center;
        }

        /* Owner */
        .chat-message.owner .message {
            background-image: linear-gradient(to right, #05531C, #222222);
            box-shadow: -2px 0px 20px rgba(71, 237, 118, 1), inset 0px 0px 10px rgba(71, 237, 118, 1);
            color: #ffffff;
        }
        .chat-message.owner .badge {
            background-image: linear-gradient(to right, #06EC47, #11B23F);
            box-shadow: 0px 0px 12px rgba(71, 237, 118, 1);
            color: #222222;
        }
        .chat-message.owner .message::before {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/3flow%20green%20shad.svg');
            width: 120px; aspect-ratio: 48 / 32; top: -28px; right: -44px; z-index: 4;
        }
        .chat-message.owner .message::after {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
            width: 60px; aspect-ratio: 28 / 20; bottom: 6px; right: -26px; z-index: 4;
            animation: sway 1s ease-in-out infinite alternate;
        }
        .chat-message.owner .ornament-extra-1 {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
            width: 60px; aspect-ratio: 28 / 20; top: 0; left: -30px; z-index: 4;
            transform: rotate(-90deg);
            animation: sway-tilt-neg-90 1s ease-in-out infinite alternate;
        }
        .chat-message.owner .ornament-extra-2 {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/1flow%20green%20shad.svg');
            width: 50px; aspect-ratio: 24 / 24; bottom: 22px; left: -26px; z-index: 5;
        }

        /* Moderator */
        .chat-message.moderator .message {
        background-image: linear-gradient(to right, #05531C, #222222);
        box-shadow: -2px 0px 20px rgba(71, 237, 118, 1), inset 0px 0px 10px rgba(71, 237, 118, 1);
        color: #ffffff;
        }
        .chat-message.moderator .badge {
        background-image: linear-gradient(to right, #06EC47, #11B23F);
        box-shadow: 0px 0px 12px rgba(71, 237, 118, 1);
        color: #222222;
        }
        .chat-message.moderator .message::before {
        background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/1flow%20green%20shad.svg');
        width: 50px; aspect-ratio: 24 / 24; bottom: 22px; left: -26px; z-index: 5;
        }
        .chat-message.moderator .message::after {
        background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
        width: 60px; aspect-ratio: 28 / 20; bottom: 6px; right: -26px; z-index: 4;
        animation: sway 1s ease-in-out infinite alternate;
        }

        /* Member */
        .chat-message.member .message {
        background-image: linear-gradient(to right, #00DE3F, #009129);
        box-shadow: -2px 0px 20px rgba(71, 237, 118, 1), inset 0px 0px 10px rgba(71, 237, 118, 1);
        color: #222222;
        }
        .chat-message.member .badge {
        background-color: #222222;
        box-shadow: 0px 1px 12px rgba(34, 34, 34, 1), 0px -2px 12px rgba(71, 237, 118, 1);
        color: #ffffff;
        }
        .chat-message.member .message::before {
        background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/3flow%20blak%20shad.svg');
        width: 120px; aspect-ratio: 48 / 32; top: -28px; right: -44px; z-index: 4;
        }
        .chat-message.member .message::after {
        background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
        width: 60px; aspect-ratio: 28 / 20; bottom: 6px; right: -26px; z-index: 4;
        transform: rotate(90deg);
        animation: sway-tilt-neg90 1s ease-in-out infinite alternate;
        }
        .chat-message.member .ornament-extra-1 {
        background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/leaf%20green%20shad.svg');
        width: 60px; aspect-ratio: 28 / 20; top: 0; left: -30px; z-index: 4;
        transform: rotate(-90deg);
        animation: sway-tilt-neg-90 1s ease-in-out infinite alternate;
        }
        .chat-message.member .ornament-extra-2 {
        background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/1flow%20black%20shad.svg');
        width: 50px; aspect-ratio: 24 / 24; bottom: 22px; left: -26px; z-index: 5;
        }

        /* Regular */
        .chat-message.regular .message {
        background-color: #222222;
        box-shadow: -2px 0px 20px rgba(71, 237, 118, 1), inset 0px 0px 10px rgba(71, 237, 118, 1);
        color: #ffffff;
        }
        .chat-message.regular .badge {
        background-image: linear-gradient(to right, #06EC47, #11B23F);
        box-shadow: 0px 0px 12px rgba(71, 237, 118, 1);
        color: #222222;
        }
        .chat-message.regular .message::before {
        background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/3flow%20blak%20shad.svg');
        width: 120px; aspect-ratio: 48 / 32; top: -28px; right: -44px; z-index: 4;
        }
        /* Special Cards */
        .special-card {
            position: relative; background: #222222; color: #ffffff;
            border-radius: 8px; width: 380px; min-height: 40px;
            padding: 12px; text-align: center; font-weight: bold;
            box-sizing: border-box;
        }
        .special-badge {
            position: absolute; top: -10px; left: 50%;
            transform: translateX(-50%) rotate(-2deg);
            background: #222222; color: #ffffff; font-weight: 700;
            font-size: 12px; padding: 2px 12px; border-radius: 4px;
        }
        .special-message {
            font-size: 18px; font-weight: bold; color: #ffffff;
        }

        /* Animasi */
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3) translateX(-50px) translateY(50px); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { opacity: 1; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1) translateY(-50px); }
            to { opacity: 0; transform: scale(0); }
        }
        /* Animasi ornamen */
        @keyframes sway {
            from { transform: rotate(-6deg); }
            to { transform: rotate(6deg); }
        }
        @keyframes sway-tilt-neg-90 {
            from { transform: rotate(-96deg); }
            to { transform: rotate(-84deg); }
        }
        @keyframes sway-tilt-neg90 {
            from { transform: rotate(84deg); }
            to { transform: rotate(96deg); }
        }
    </style>
</head>
<body>
    <div id="output"></div>

    <script>
    const urlParams = new URLSearchParams(window.location.search);
    
    const App = {
        // Bagian KONEKSI dari templat asli (tetap dipertahankan)
        // =======================================================
        config: { serverURL: (urlParams.has("localserver") ? "ws://127.0.0.1:3000" : 'wss://io.socialstream.ninja') },
        state: { roomID: 'test', password: 'false' },

        init() {
            this.handleRoomIdParam(urlParams);
            this.state.password = urlParams.get('password') || 'false';
            this.initializeConnection();
        },

        initializeConnection() {
            // Logika koneksi (iframe atau websocket) tetap sama
            const iframe = document.createElement('iframe');
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${this.state.password}&notmobile&salt=vdo.ninja&label=overlay&exclude=${this.state.roomID}&scene&novideo&noaudio&cleanoutput&room=${this.state.roomID}`;
            iframe.style.cssText = "width:0;height:0;border:0;position:absolute;top:-10px;left:-10px;";
            document.body.appendChild(iframe);
            window.addEventListener('message', (e) => {
                if (e.source !== iframe.contentWindow) return;
                if (e.data?.dataReceived && ("overlayNinja" in e.data.dataReceived)){
                    this.processData({ contents: e.data.dataReceived.overlayNinja });
                }
            });
        },
        
        handleRoomIdParam(urlParams) {
             let roomID = urlParams.get('session') || urlParams.get('s') || urlParams.get('id');
             if (!roomID) {
                document.body.innerHTML = '<h1>Error: Missing ?session=ID parameter in URL</h1>';
                throw new Error("Missing session ID");
             }
             this.state.roomID = roomID;
        },

        processData(data) {
            // Jika data kosong, bersihkan layar
            if (!data || data.contents === false) {
                document.getElementById('output').innerHTML = '';
                return;
            }
            // Jika ada data, panggil showMessage
            if (data.contents) {
                this.showMessage(data.contents);
            }
        },

        // FUNGSI INTI ANDA (sudah bersih dan terintegrasi)
        // ===============================================
        // GANTIKAN FUNGSI showMessage LAMA ANDA DENGAN YANG INI
        showMessage(data) {
            const content = data;

            // --- LOGIKA BARU YANG SUDAH DISEMPURNAKAN ---

            // Prioritas 1: Event "New Subscriber" TULEN (hanya notifikasi, tanpa isi chat)
            if (content.membership && !content.chatmessage) {
                const messageContent = `
                    <div class="chat-message new-subscriber">
                        <div class="special-card new-subscriber">
                            <div class="special-badge">NEW SUBSCRIBER</div>
                            <div class="special-message">${content.chatname} ${content.membership}</div>
                        </div>
                    </div>
                `;
                document.getElementById('output').innerHTML = messageContent;
                return; // Hentikan di sini
            }

            // Prioritas 2: Donasi
            if (content.hasDonation) {
                const messageContent = `
                    <div class="chat-message donation">
                        <div class="special-card donation">
                            <div class="special-badge">DONATION</div>
                            <div class="special-message">${content.chatname} ${content.hasDonation}</div>
                        </div>
                    </div>
                `;
                document.getElementById('output').innerHTML = messageContent;
                return; // Hentikan di sini
            }

            // Jika lolos dari atas, ini adalah pesan obrolan biasa.
            // Sekarang kita tentukan gayanya.

            // 2. Deteksi Peran dari Lencana atau Properti Membership
            let roleClass = 'regular';
            
            // Deteksi Member YouTube secara spesifik
            if (content.membership === "MEMBERSHIP") {
                roleClass = 'member';
            } 
            // Deteksi peran lain dari lencana
            else if (content.chatbadges) {
                const badgeSrcs = content.chatbadges.map(badge => (badge.src || badge).toLowerCase());
                
                if (badgeSrcs.some(src => src.includes('broadcaster') || src.includes('owner'))) {
                    roleClass = 'owner';
                } else if (badgeSrcs.some(src => src.includes('moderator') || src.includes('moderater'))) {
                    roleClass = 'moderator';
                } else if (
                    badgeSrcs.some(src =>
                        src.includes('gifter') ||
                        src.includes('subscriber') ||
                        (src.includes('fans_badge') && !src.includes('grey'))
                    )
                ) {
                    roleClass = 'member';
                }
            }

            // 3. Buat HTML untuk pesan obrolan biasa dengan peran yang sesuai
            const messageContent = `
                <div class="chat-message ${roleClass}">
                    <div class="badge">${content.chatname}</div>
                    <div class="message">
                        ${content.chatmessage}
                        <span class="ornament-extra-1"></span>
                        <span class="ornament-extra-2"></span>
                    </div>
                </div>
            `;

            // 4. Tampilkan Hasilnya
            document.getElementById('output').innerHTML = messageContent;
        }
    };

    // Initialize the application when DOM is ready
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>