<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Social Stream - Custom Highlight</title>
    <meta name="robots" content="noindex">
    <style>
        /* -- TEMA KUSTOM FINAL ANDA -- */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;900&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
        }

        #output {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: visible;
        }

        /* Ini adalah nama class yang dibuat oleh JS di bawah */
        .chat-message {
            opacity: 0;
            animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            display: inline-block;
            align-self: flex-start;
        }

        .badge {
            font-weight: 700; color: #ffffff; padding: 2px 10px;
            border-radius: 12px; font-size: 10px; position: absolute;
            top: -10px; left: 20px; z-index: 99; background-color: #222222;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;
        }

        .message {
            font-weight: 700; background: #222222; color: #ffffff;
            font-size: 14px; padding: 16px 24px;
            border-radius: 4px 24px 4px 24px; display: inline-block;
            min-width: 100px; box-sizing: border-box; overflow-wrap: break-word;
            position: relative; left: 10px; max-width: 380px;
        }

        .message img.emoji {
            width: 14px; height: 14px; vertical-align: middle;
        }

        .message::before, .message::after, .ornament-extra-1, .ornament-extra-2 {
            content: ''; position: absolute; background-size: contain;
            background-repeat: no-repeat; transform-origin: bottom center;
        }

        /* Owner */
        .chat-message.owner .badge {
            background-image: linear-gradient(to right, #06EC47, #11B23F);
            color: #222222;
        }
        .chat-message.owner .message {
            background-image: linear-gradient(to right, #05531C, #222222);
        }
        .chat-message.owner .message::before {
            background-image: url('https://raw.githubusercontent.com/Kirito55-test/test-streamelement-svg/aa6dce2947015022e019588df0b78b40805af9d2/3flow%20green%20shad.svg');
            width: 48px; height: 32px; top: -11px; right: -11px; z-index: 4;
        }
        /* ... Tempelkan sisa gaya peran (owner ornaments, moderator, member, dll) di sini ... */

        /* Special Cards */
        .special-card {
            position: relative; background: #222222; color: #ffffff;
            border-radius: 8px; width: 380px; min-height: 40px;
            padding: 12px; text-align: center; font-weight: bold;
            box-sizing: border-box;
        }
        .special-badge {
            position: absolute; top: -10px; left: 50%;
            transform: translateX(-50%) rotate(-2deg);
            background: #222222; color: #ffffff; font-weight: 700;
            font-size: 12px; padding: 2px 12px; border-radius: 4px;
        }
        .special-message {
            font-size: 18px; font-weight: bold; color: #ffffff;
        }

        /* Animasi */
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3) translateX(-80px) translateY(50px) rotate(20deg); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { opacity: 1; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-50px); } }
        @keyframes sway { from { transform: rotate(-6deg); } to { transform: rotate(6deg); } }
        /* ... (tambahkan @keyframes lainnya jika perlu) ... */

    </style>
</head>
<body>
    <div id="output"></div>

    <script>
    const urlParams = new URLSearchParams(window.location.search);
    
    const App = {
        // Bagian KONEKSI dari templat asli (tetap dipertahankan)
        // =======================================================
        config: { serverURL: (urlParams.has("localserver") ? "ws://127.0.0.1:3000" : 'wss://io.socialstream.ninja') },
        state: { roomID: 'test', password: 'false' },

        init() {
            this.handleRoomIdParam(urlParams);
            this.state.password = urlParams.get('password') || 'false';
            this.initializeConnection();
        },

        initializeConnection() {
            // Logika koneksi (iframe atau websocket) tetap sama
            const iframe = document.createElement('iframe');
            iframe.src = `https://vdo.socialstream.ninja/?ln&password=${this.state.password}&notmobile&salt=vdo.ninja&label=overlay&exclude=${this.state.roomID}&scene&novideo&noaudio&cleanoutput&room=${this.state.roomID}`;
            iframe.style.cssText = "width:0;height:0;border:0;position:absolute;top:-10px;left:-10px;";
            document.body.appendChild(iframe);
            window.addEventListener('message', (e) => {
                if (e.source !== iframe.contentWindow) return;
                if (e.data?.dataReceived && ("overlayNinja" in e.data.dataReceived)){
                    this.processData({ contents: e.data.dataReceived.overlayNinja });
                }
            });
        },
        
        handleRoomIdParam(urlParams) {
             let roomID = urlParams.get('session') || urlParams.get('s') || urlParams.get('id');
             if (!roomID) {
                document.body.innerHTML = '<h1>Error: Missing ?session=ID parameter in URL</h1>';
                throw new Error("Missing session ID");
             }
             this.state.roomID = roomID;
        },

        processData(data) {
            // Jika data kosong, bersihkan layar
            if (!data || data.contents === false) {
                document.getElementById('output').innerHTML = '';
                return;
            }
            // Jika ada data, panggil showMessage
            if (data.contents) {
                this.showMessage(data.contents);
            }
        },

        // FUNGSI INTI ANDA (sudah bersih dan terintegrasi)
        // ===============================================
        showMessage(data) {
            const content = data;

            // 1. Logika Deteksi Peran
            let roleClass = 'regular';
            if (content.chatbadges) {
                const badgeSrcs = content.chatbadges.map(badge => (badge.src || badge).toLowerCase());
                if (badgeSrcs.some(src => src.includes('broadcaster') || src.includes('owner'))) {
                    roleClass = 'owner';
                } else if (badgeSrcs.some(src => src.includes('moderator') || src.includes('moderater'))) {
                    roleClass = 'moderator';
                } else if (
                    badgeSrcs.some(src =>
                        src.includes('gifter') ||
                        src.includes('subscriber') ||
                        src.includes('member') ||
                        (src.includes('fans_badge') && !src.includes('grey'))
                    )
                ) {
                    roleClass = 'member';
                }
            }

            // 2. Pembuatan HTML Sesuai Desain Anda
            let messageContent = '';

            if (content.hasDonation || content.membership) {
                let badgeText = content.hasDonation ? 'DONATION' : 'NEW SUBSCRIBER';
                let cardRole = content.hasDonation ? 'donation' : 'new-subscriber';
                let messageText = content.hasDonation || content.membership;
                messageContent = `
                    <div class="chat-message ${cardRole}">
                        <div class="special-card ${cardRole}">
                            <div class="special-badge">${badgeText}</div>
                            <div class="special-message">${content.chatname} ${messageText}</div>
                        </div>
                    </div>
                `;
            } else {
                messageContent = `
                    <div class="chat-message ${roleClass}">
                        <div class="badge">${content.chatname}</div>
                        <div class="message">
                            ${content.chatmessage}
                            <span class="ornament-extra-1"></span>
                            <span class="ornament-extra-2"></span>
                        </div>
                    </div>
                `;
            }

            // 3. Tampilkan Hasilnya
            document.getElementById('output').innerHTML = messageContent;
        }
    };

    // Initialize the application when DOM is ready
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>